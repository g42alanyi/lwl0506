<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Merry Christmas to éµéµ</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@700&display=swap');
        body { margin: 0; overflow: hidden; background: #020205; font-family: serif; touch-action: none; }
        #instructions {
            position: absolute; top: 40px; width: 100%; text-align: center;
            color: #ffd700; font-size: clamp(20px, 5vw, 32px); pointer-events: none; 
            text-shadow: 0 0 15px rgba(255,215,0,0.7);
            font-family: 'Noto Serif TC', serif; z-index: 10;
        }
        #audio-hint {
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
            color: #fff; cursor: pointer; border: 1px solid #d4af37; padding: 14px 28px; 
            border-radius: 35px; background: rgba(212,175,55,0.4); backdrop-filter: blur(10px);
            font-family: 'Noto Serif TC', serif; z-index: 100; white-space: nowrap;
            box-shadow: 0 0 20px rgba(212,175,55,0.3); transition: all 0.3s;
        }
        #audio-hint:active { transform: translateX(-50%) scale(0.95); background: rgba(212,175,55,0.6); }
        /* éš±è— Bilibili æ’­æ”¾å™¨ */
        #bili-player { position: absolute; width: 1px; height: 1px; opacity: 0; pointer-events: none; }
    </style>
</head>
<body>
    <div id="instructions">Merry Christmas to éµéµ</div>
    <div id="audio-hint" onclick="playMusic()">ğŸ„ é»æ“Šé»äº®è–èª• & æ’­æ”¾ã€Šåˆåˆ°è–èª•ã€‹</div>

    <iframe id="bili-player" src="//player.bilibili.com/player.html?bvid=BV1vX4y1M78y&page=1&autoplay=0" scrolling="no" border="0" frameborder="no" framespacing="0" allowfullscreen="true"></iframe>

<script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
        }
    }
</script>

<script type="module">
import * as THREE from 'three';
import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
import gsap from 'https://cdn.skypack.dev/gsap';

// --- åˆå§‹åŒ–å ´æ™¯ ---
const scene = new THREE.Scene();
const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
const renderer = new THREE.WebGLRenderer({ antialias: true });
renderer.setSize(window.innerWidth, window.innerHeight);
renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
renderer.toneMapping = THREE.ACESFilmicToneMapping;
renderer.toneMappingExposure = 1.8; 
document.body.appendChild(renderer.domElement);

const controls = new OrbitControls(camera, renderer.domElement);
camera.position.set(0, 15, 35);
controls.enableDamping = true;
controls.enablePan = false;

scene.add(new THREE.AmbientLight(0xffffff, 1.2));
const pointLight = new THREE.PointLight(0xffffff, 1000);
pointLight.position.set(10, 20, 10);
scene.add(pointLight);

// --- è–èª•æ¨¹èˆ‡æ–‡å­—ç²’å­ (10,000) ---
const COUNT = 10000;
const dummy = new THREE.Object3D();
let currentState = 'tree';

const pbrMat = new THREE.MeshStandardMaterial({ metalness: 1, roughness: 0.1, emissiveIntensity: 0.3 });
const sphereGeo = new THREE.SphereGeometry(0.12, 12, 12);
const instMesh = new THREE.InstancedMesh(sphereGeo, pbrMat, COUNT);
scene.add(instMesh);

const treePos = [];
const textPos = [];

for (let i = 0; i < COUNT; i++) {
    const ratio = i / COUNT;
    const height = ratio * 22;
    const radius = (1 - ratio) * 9;
    const angle = i * 0.25;
    const dist = Math.sqrt(Math.random()) * radius;
    treePos.push(new THREE.Vector3(Math.cos(angle) * dist, height - 8, Math.sin(angle) * dist));
    
    let color = new THREE.Color();
    const r = Math.random();
    if (r < 0.6) color.setHex(0xFFD700); 
    else if (r < 0.8) color.setHex(0xFF0000); 
    else color.setHex(0x00FF44); 
    instMesh.setColorAt(i, color);
}

function createTextCoords() {
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    canvas.width = 1600; canvas.height = 400;
    ctx.fillStyle = 'white';
    ctx.font = 'bold 85px serif, "Noto Serif TC"';
    ctx.textAlign = 'center';
    ctx.fillText('Merry Christmas to éµéµ', 800, 200);
    const data = ctx.getImageData(0, 0, 1600, 400).data;
    const points = [];
    for (let y = 0; y < 400; y += 4) {
        for (let x = 0; x < 1600; x += 4) {
            if (data[(y * 1600 + x) * 4] > 128) points.push(new THREE.Vector3((x - 800) * 0.05, (200 - y) * 0.05 + 6, 0));
        }
    }
    for (let i = 0; i < COUNT; i++) textPos.push(points[i % points.length].clone());
}
createTextCoords();

const topStar = new THREE.Mesh(new THREE.OctahedronGeometry(1.5, 0), new THREE.MeshStandardMaterial({ color: 0xffff00, emissive: 0xffaa00, emissiveIntensity: 5 }));
topStar.position.y = 16;
scene.add(topStar);

// --- å®Œæ•´çš„ç´°ç¯€è²“å’ª ---
const catGroup = new THREE.Group();
const orangeMat = new THREE.MeshStandardMaterial({ color: 0xffa500 });
const whiteMat = new THREE.MeshStandardMaterial({ color: 0xf0f0f0 });
const pinkMat = new THREE.MeshStandardMaterial({ color: 0xffc0cb });
const darkMat = new THREE.MeshStandardMaterial({ color: 0x222222 });

const body = new THREE.Mesh(new THREE.SphereGeometry(1, 32, 32), orangeMat);
body.scale.set(1.4, 1.0, 1.1);
catGroup.add(body);

const head = new THREE.Mesh(new THREE.SphereGeometry(0.75, 32, 32), orangeMat);
head.position.set(1.1, 0.7, 0);
catGroup.add(head);

const earGeo = new THREE.ConeGeometry(0.25, 0.5, 3);
const earL = new THREE.Mesh(earGeo, orangeMat);
earL.position.set(1.2, 1.3, 0.3); earL.rotation.x = 0.2;
const earR = earL.clone(); earR.position.z = -0.3;
catGroup.add(earL, earR);

const cheekGeo = new THREE.SphereGeometry(0.2, 16, 16);
const cheekL = new THREE.Mesh(cheekGeo, whiteMat);
cheekL.position.set(1.7, 0.5, 0.15);
const cheekR = cheekL.clone(); cheekR.position.z = -0.15;
catGroup.add(cheekL, cheekR);

const nose = new THREE.Mesh(new THREE.SphereGeometry(0.08, 8, 8), pinkMat);
nose.position.set(1.85, 0.65, 0);
catGroup.add(nose);

const eyeGeo = new THREE.SphereGeometry(0.07, 8, 8);
const eyeL = new THREE.Mesh(eyeGeo, darkMat);
eyeL.position.set(1.7, 0.85, 0.25);
const eyeR = eyeL.clone(); eyeR.position.z = -0.25;
catGroup.add(eyeL, eyeR);

const legGeo = new THREE.CapsuleGeometry(0.18, 0.4, 4, 8);
const footGeo = new THREE.SphereGeometry(0.2, 8, 8);
const foot = new THREE.Mesh(footGeo, whiteMat); foot.position.set(0, -0.3, 0);

const legPositions = [[0.8, -0.7, 0.5], [0.8, -0.7, -0.5], [-0.5, -0.7, 0.5], [-0.5, -0.7, -0.5]];
legPositions.forEach(p => {
    const l = new THREE.Mesh(legGeo, orangeMat);
    l.position.set(...p); l.add(foot.clone()); catGroup.add(l);
});

const tail = new THREE.Mesh(new THREE.CapsuleGeometry(0.15, 1.0, 4, 8), orangeMat);
tail.position.set(-1.3, 0.5, 0); tail.rotation.z = Math.PI/4;
catGroup.add(tail);

catGroup.position.set(15, -6, 8); catGroup.scale.set(2.2, 2.2, 2.2);
scene.add(catGroup);

// é›ªèŠ±
const snowGeo = new THREE.BufferGeometry();
const snowPos = new Float32Array(5000 * 3);
for(let i=0; i<15000; i++) snowPos[i] = (Math.random()-0.5) * 150;
snowGeo.setAttribute('position', new THREE.BufferAttribute(snowPos, 3));
const snow = new THREE.Points(snowGeo, new THREE.PointsMaterial({ color: 0xffffff, size: 0.15, transparent: true, opacity: 0.8 }));
scene.add(snow);

// --- å‹•æ…‹èˆ‡è¼¸å…¥ ---
const raycaster = new THREE.Raycaster();
const mouse = new THREE.Vector2();

function transition(targetArray) {
    const startPositions = [];
    const m = new THREE.Matrix4();
    for(let i=0; i<COUNT; i++) {
        instMesh.getMatrixAt(i, m);
        startPositions.push(new THREE.Vector3().setFromMatrixPosition(m));
    }
    const obj = { t: 0 };
    gsap.to(obj, {
        t: 1, duration: 1.5, ease: "power3.inOut",
        onUpdate: () => {
            for (let i = 0; i < COUNT; i++) {
                dummy.position.lerpVectors(startPositions[i], targetArray[i], obj.t);
                dummy.updateMatrix();
                instMesh.setMatrixAt(i, dummy.matrix);
            }
            instMesh.instanceMatrix.needsUpdate = true;
        }
    });
}

function handleInput(e) {
    const clientX = e.touches ? e.touches[0].clientX : e.clientX;
    const clientY = e.touches ? e.touches[0].clientY : e.clientY;
    mouse.x = (clientX / window.innerWidth) * 2 - 1;
    mouse.y = -(clientY / window.innerHeight) * 2 + 1;

    raycaster.setFromCamera(mouse, camera);
    const intersects = raycaster.intersectObjects(scene.children, true);
    
    if (intersects.length > 0) {
        let isCat = false;
        intersects[0].object.traverseAncestors(obj => { if(obj === catGroup) isCat = true; });
        if (isCat) {
            gsap.to(catGroup.scale, { x: 2.5, y: 1.5, z: 2.5, duration: 0.1, yoyo: true, repeat: 1 });
            return;
        }
    }

    if (currentState === 'tree') {
        const scat = treePos.map(p => p.clone().add(new THREE.Vector3((Math.random()-0.5)*30, (Math.random()-0.5)*30, (Math.random()-0.5)*30)));
        transition(scat); currentState = 'scatter';
    } else if (currentState === 'scatter') {
        transition(textPos); currentState = 'text';
    } else {
        transition(treePos); currentState = 'tree';
    }
}

window.addEventListener('mousedown', handleInput);
window.addEventListener('touchstart', (e) => {
    if(e.target.id === 'audio-hint') return;
    handleInput(e);
}, { passive: false });

function animate() {
    requestAnimationFrame(animate);
    if (currentState === 'tree') { instMesh.rotation.y += 0.005; topStar.rotation.y += 0.02; }
    const pos = snow.geometry.attributes.position.array;
    for(let i=1; i<pos.length; i+=3) {
        pos[i] -= 0.12;
        if(pos[i] < -20) pos[i] = 60;
    }
    snow.geometry.attributes.position.needsUpdate = true;
    controls.update();
    renderer.render(scene, camera);
}

for (let i = 0; i < COUNT; i++) {
    dummy.position.copy(treePos[i]);
    dummy.updateMatrix();
    instMesh.setMatrixAt(i, dummy.matrix);
}
animate();

// --- éŸ³æ¨‚å•Ÿå‹•å™¨ ---
window.playMusic = () => {
    const iframe = document.getElementById('bili-player');
    // é‡æ–°åŠ è¼‰é€£çµä¸¦åŠ ä¸Š autoplay=1
    iframe.src = "//player.bilibili.com/player.html?bvid=BV1vX4y1M78y&page=1&autoplay=1";
    document.getElementById('audio-hint').style.display = 'none';
}

window.addEventListener('resize', () => {
    camera.aspect = window.innerWidth / window.innerHeight; camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
});
</script>
</body>
</html>

