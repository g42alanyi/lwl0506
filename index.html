<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>Merry Christmas to éµéµ</title>
    <style>
        @font-face {
            font-family: 'Noto Serif TC';
            src: url('https://fonts.gstatic.com/s/notoseriftc/v19/XLYgR5vtWpzzTfPR--iJ_y2W4k_B3N-Y76kP_D_A7_N.woff2') format('woff2');
        }
        body { margin: 0; overflow: hidden; background: #010103; }
        #instructions {
            position: absolute; top: 40px; width: 100%; text-align: center;
            color: #ffefad; font-size: 32px; pointer-events: none; 
            text-shadow: 0 0 20px rgba(255,215,0,0.8);
            font-family: 'Times New Roman', 'Noto Serif TC', serif;
            letter-spacing: 2px; z-index: 10;
        }
        #audio-hint {
            position: absolute; bottom: 30px; left: 30px; color: #fff; cursor: pointer;
            border: 1px solid #d4af37; padding: 12px 24px; border-radius: 30px;
            background: rgba(212,175,55,0.2); font-family: 'Noto Serif TC', serif;
            backdrop-filter: blur(10px); z-index: 100;
        }
    </style>
</head>
<body>

<div id="instructions">Merry Christmas to éµéµ</div>
<div id="audio-hint" onclick="playMusic()">ğŸµ é»æ“Šé»äº®è–èª•ç¯€</div>

<script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
        }
    }
</script>

<script type="module">
import * as THREE from 'three';
import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
import gsap from 'https://cdn.skypack.dev/gsap';

// --- åˆå§‹åŒ–æ¸²æŸ“å™¨ ---
const scene = new THREE.Scene();
const camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
const renderer = new THREE.WebGLRenderer({ antialias: true });
renderer.setSize(window.innerWidth, window.innerHeight);
renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
renderer.toneMapping = THREE.ACESFilmicToneMapping;
renderer.toneMappingExposure = 1.8; // é¡¯è‘—æé«˜äº®åº¦
document.body.appendChild(renderer.domElement);

const controls = new OrbitControls(camera, renderer.domElement);
camera.position.set(0, 10, 35);
controls.target.set(0, 5, 0);
controls.enableDamping = true;

// --- ç‡ˆå…‰ç³»çµ± (æ¥µäº®) ---
scene.add(new THREE.AmbientLight(0xffffff, 1.0)); 
const sunLight = new THREE.DirectionalLight(0xffffff, 2.0);
sunLight.position.set(5, 20, 10);
scene.add(sunLight);

const pointLight1 = new THREE.PointLight(0xffd700, 1000, 100);
pointLight1.position.set(-10, 10, 10);
scene.add(pointLight1);

// --- è–èª•æ¨¹ 15,000 ç²’å­ ---
const COUNT = 15000;
const dummy = new THREE.Object3D();
let currentState = 'tree';

// å¼·åŒ–çš„ PBR æè³ª
const treeMat = new THREE.MeshStandardMaterial({ 
    metalness: 1.0, 
    roughness: 0.1,
    emissiveIntensity: 0.2
});

const sphereGeo = new THREE.SphereGeometry(0.12, 8, 8);
const treeMesh = new THREE.InstancedMesh(sphereGeo, treeMat, COUNT);
scene.add(treeMesh);

const treePos = [];
const textPos = [];

// ç”Ÿæˆæ¨¹åº§æ¨™èˆ‡é¡è‰²
for (let i = 0; i < COUNT; i++) {
    const ratio = i / COUNT;
    const height = ratio * 22;
    const radius = (1 - ratio) * 9;
    const angle = i * 0.2;
    const dist = Math.sqrt(Math.random()) * radius;
    treePos.push(new THREE.Vector3(Math.cos(angle) * dist, height - 8, Math.sin(angle) * dist));

    // åš´æ ¼åˆ†é…é¡è‰²
    const color = new THREE.Color();
    const r = Math.random();
    if (r < 0.5) color.setHex(0xFFD700); // åœŸè±ªé‡‘
    else if (r < 0.8) color.setHex(0xDD0000); // é®®ç´…
    else color.setHex(0x00AA44); // è–èª•ç¶ 
    treeMesh.setColorAt(i, color);
}

// --- æ–‡å­—åº§æ¨™ ---
function initText() {
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    canvas.width = 1600; canvas.height = 400;
    ctx.fillStyle = 'white';
    ctx.font = 'bold 90px "Times New Roman", "Noto Serif TC", serif';
    ctx.textAlign = 'center';
    ctx.fillText('Merry Christmas to éµéµ', 800, 200);
    
    const data = ctx.getImageData(0, 0, 1600, 400).data;
    const pts = [];
    for (let y = 0; y < 400; y += 4) {
        for (let x = 0; x < 1600; x += 4) {
            if (data[(y * 1600 + x) * 4] > 128) {
                pts.push(new THREE.Vector3((x - 800) * 0.05, (200 - y) * 0.05 + 6, 0));
            }
        }
    }
    for (let i = 0; i < COUNT; i++) textPos.push(pts[i % pts.length].clone());
}
initText();

// --- æ¨¹é ‚å¤§æ˜Ÿ ---
const star = new THREE.Mesh(new THREE.OctahedronGeometry(1.2, 0), new THREE.MeshStandardMaterial({ color: 0xffff00, emissive: 0xffaa00, emissiveIntensity: 5 }));
star.position.y = 15;
scene.add(star);

// --- ç¨ç«‹çš„æ©˜è²“ç‰©ä»¶ (åˆ†é–‹æ§‹å»ºï¼Œé¿å…è¢« Instance å½±éŸ¿) ---
const cat = new THREE.Group();
const orange = new THREE.MeshStandardMaterial({ color: 0xff8800, roughness: 0.6 });
const white = new THREE.MeshStandardMaterial({ color: 0xffffff, roughness: 0.8 });

const body = new THREE.Mesh(new THREE.SphereGeometry(1, 20, 20), orange);
body.scale.set(1.3, 0.8, 1);
cat.add(body);

const head = new THREE.Mesh(new THREE.SphereGeometry(0.7, 20, 20), orange);
head.position.set(1.1, 0.6, 0);
cat.add(head);

const tail = new THREE.Mesh(new THREE.CapsuleGeometry(0.15, 0.8), orange);
tail.position.set(-1.1, 0.5, 0);
tail.rotation.z = Math.PI/4;
cat.add(tail);

cat.position.set(18, -7, 10); // ç¢ºä¿é é›¢æ¨¹
cat.scale.set(2.5, 2.5, 2.5);
scene.add(cat);

// --- é›ªèŠ± ---
const snowGeo = new THREE.BufferGeometry();
const snowBuf = new Float32Array(8000 * 3);
for(let i=0; i<24000; i++) snowBuf[i] = (Math.random()-0.5)*150;
snowGeo.setAttribute('position', new THREE.BufferAttribute(snowBuf, 3));
const snow = new THREE.Points(snowGeo, new THREE.PointsMaterial({ color: 0xffffff, size: 0.1, transparent: true, opacity: 0.7 }));
scene.add(snow);

// --- å‹•æ…‹é‚è¼¯ ---
function transition(targetArray) {
    const currentPos = [];
    const m = new THREE.Matrix4();
    for(let i=0; i<COUNT; i++) {
        treeMesh.getMatrixAt(i, m);
        currentPos.push(new THREE.Vector3().setFromMatrixPosition(m));
    }

    const obj = { t: 0 };
    gsap.to(obj, {
        t: 1, duration: 2.2, ease: "power4.inOut",
        onUpdate: () => {
            for (let i = 0; i < COUNT; i++) {
                dummy.position.lerpVectors(currentPos[i], targetArray[i], obj.t);
                dummy.updateMatrix();
                treeMesh.setMatrixAt(i, dummy.matrix);
            }
            treeMesh.instanceMatrix.needsUpdate = true;
        }
    });
}

// --- é»æ“Šç›£è½ ---
const raycaster = new THREE.Raycaster();
const mouse = new THREE.Vector2();

window.addEventListener('mousedown', (e) => {
    mouse.x = (e.clientX / window.innerWidth) * 2 - 1;
    mouse.y = -(e.clientY / window.innerHeight) * 2 + 1;
    raycaster.setFromCamera(mouse, camera);

    const intersects = raycaster.intersectObjects(scene.children, true);
    if (intersects.length > 0) {
        let isCat = false;
        intersects[0].object.traverseAncestors(a => { if(a === cat) isCat = true; });
        if (isCat) {
            gsap.to(cat.scale, { x: 2.8, y: 2.2, z: 2.8, duration: 0.1, yoyo: true, repeat: 1 });
            return;
        }
    }

    if (currentState === 'tree') {
        const scat = treePos.map(p => p.clone().add(new THREE.Vector3((Math.random()-0.5)*40, (Math.random()-0.5)*40, (Math.random()-0.5)*40)));
        transition(scat); currentState = 'scatter';
    } else if (currentState === 'scatter') {
        transition(textPos); currentState = 'text';
    } else {
        transition(treePos); currentState = 'tree';
    }
});

// --- æ¸²æŸ“ ---
function animate() {
    requestAnimationFrame(animate);
    if (currentState === 'tree') treeMesh.rotation.y += 0.005;
    
    const pos = snow.geometry.attributes.position.array;
    for(let i=1; i<pos.length; i+=3) {
        pos[i] -= 0.06;
        if(pos[i] < -20) pos[i] = 50;
    }
    snow.geometry.attributes.position.needsUpdate = true;

    controls.update();
    renderer.render(scene, camera);
}

// åˆå§‹åŒ–ä½ç½®
for (let i = 0; i < COUNT; i++) {
    dummy.position.copy(treePos[i]);
    dummy.updateMatrix();
    treeMesh.setMatrixAt(i, dummy.matrix);
}
treeMesh.instanceMatrix.needsUpdate = true;
animate();

// éŸ³æ¨‚æ’­æ”¾
const sound = new THREE.Audio(new THREE.AudioListener());
window.playMusic = () => {
    if (!sound.isPlaying) {
        new THREE.AudioLoader().load('https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3', (b) => {
            sound.setBuffer(b); sound.setLoop(true); sound.play();
        });
        document.getElementById('audio-hint').style.display = 'none';
    }
}

window.addEventListener('resize', () => {
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
});
</script>
</body>
</html>

